<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'" />
  <title>DocuFlow Desktop Agent</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      user-select: none;
    }
    .logo { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; }
    .subtitle { font-size: 0.8rem; color: #94a3b8; margin-bottom: 2rem; }

    /* Views */
    .view { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 320px; }
    .view.active { display: flex; }

    /* Form */
    label { font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.25rem; align-self: flex-start; }
    input {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #334155;
      background: #1e293b;
      color: #e2e8f0;
      font-size: 0.9rem;
      outline: none;
      margin-bottom: 1rem;
    }
    input:focus { border-color: #6366f1; }
    input.code-input {
      text-align: center;
      font-family: monospace;
      font-size: 1.5rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
    }

    button {
      width: 100%;
      padding: 0.7rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
    }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: #6366f1; color: white; }
    .btn-secondary { background: #334155; color: #e2e8f0; margin-top: 0.5rem; }

    .error { color: #f87171; font-size: 0.8rem; margin-top: 0.5rem; text-align: center; }
    .status-text { font-size: 0.8rem; color: #94a3b8; margin-top: 1rem; text-align: center; }
    .connected-icon { font-size: 3rem; margin-bottom: 1rem; }
    .device-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem; }
  </style>
</head>
<body>
  <div class="logo">DocuFlow Agent</div>
  <div class="subtitle">Desktop time tracking &amp; activity monitor</div>

  <!-- Pairing View -->
  <div id="pairing-view" class="view active">
    <label for="server-url">Server URL</label>
    <input id="server-url" type="url" placeholder="https://your-docuflow.replit.app" />

    <label for="device-name">Device Name</label>
    <input id="device-name" type="text" placeholder="My Work Laptop" />

    <label for="pairing-code">Pairing Code</label>
    <input id="pairing-code" class="code-input" type="text" maxlength="6" placeholder="------" />

    <button id="pair-btn" class="btn-primary">Connect</button>
    <div id="pair-error" class="error" style="display:none"></div>
  </div>

  <!-- Connected View -->
  <div id="connected-view" class="view">
    <div class="connected-icon">&#x2705;</div>
    <div class="device-name" id="connected-device-name"></div>
    <div class="status-text">Connected and syncing</div>
    <button id="unpair-btn" class="btn-secondary" style="margin-top:2rem">Disconnect</button>
  </div>

  <script>
    const bridge = window.agentBridge;
    const pairingView = document.getElementById("pairing-view");
    const connectedView = document.getElementById("connected-view");

    async function init() {
      const state = await bridge.getState();
      if (state.isPaired) {
        showConnected(state.deviceName);
      }
    }

    function showConnected(name) {
      pairingView.classList.remove("active");
      connectedView.classList.add("active");
      document.getElementById("connected-device-name").textContent = name || "Device";
    }

    function showPairing() {
      connectedView.classList.remove("active");
      pairingView.classList.add("active");
    }

    // Pair
    document.getElementById("pair-btn").addEventListener("click", async () => {
      const serverUrl = document.getElementById("server-url").value.trim();
      const deviceName = document.getElementById("device-name").value.trim();
      const pairingCode = document.getElementById("pairing-code").value.trim().toUpperCase();
      const errorEl = document.getElementById("pair-error");
      const btn = document.getElementById("pair-btn");

      errorEl.style.display = "none";

      if (!serverUrl || !deviceName || pairingCode.length !== 6) {
        errorEl.textContent = "Please fill in all fields";
        errorEl.style.display = "block";
        return;
      }

      btn.disabled = true;
      btn.textContent = "Connecting...";

      const result = await bridge.pair({ serverUrl, pairingCode, deviceName });

      if (result.ok) {
        showConnected(deviceName);
      } else {
        errorEl.textContent = result.error || "Pairing failed";
        errorEl.style.display = "block";
      }

      btn.disabled = false;
      btn.textContent = "Connect";
    });

    // Unpair
    document.getElementById("unpair-btn").addEventListener("click", async () => {
      await bridge.unpair();
      showPairing();
    });

    init();
  </script>
</body>
</html>
